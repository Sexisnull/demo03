<!DOCTYPE html>
<html class="login-bg">
<head>
	<title>统一身份认证</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- bootstrap -->
    <link href="${request.contextPath}/static/homepage/css/bootstrap/bootstrap.css" rel="stylesheet" />
    <link href="${request.contextPath}/static/homepage/css/bootstrap/bootstrap-responsive.css" rel="stylesheet" />
    <link href="${request.contextPath}/static/homepage/css/bootstrap/bootstrap-overrides.css" type="text/css" rel="stylesheet" />

    <!-- global styles -->
    <link rel="stylesheet" type="text/css" href="${request.contextPath}/static/homepage/css/layout.css" />
    <link rel="stylesheet" type="text/css" href="${request.contextPath}/static/homepage/css/elements.css" />
    <link rel="stylesheet" type="text/css" href="${request.contextPath}/static/homepage/css/icons.css" />

    <!-- libraries -->
    <link rel="stylesheet" type="text/css" href="${request.contextPath}/static/homepage/css/lib/font-awesome.css" />

    <!-- this page specific styles -->
    <link rel="stylesheet" href="${request.contextPath}/static/homepage/css/compiled/signin.css" type="text/css" media="screen" />

    <!-- open sans font -->
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css' />

	<script type="text/javascript" src="${request.contextPath}/static/jquery/jquery-1.8.0.min.js"></script>
	<script type="text/javascript" src="${request.contextPath}/static/layer/layer.js"></script>
	<script src="${request.contextPath}/static/homepage/js/bootstrap.min.js"></script>
	<script src="${request.contextPath}/static/homepage/js/theme.js"></script>
	
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /></head>
<body>


    <!-- background switcher -->
    <div class="bg-switch visible-desktop">
        <div class="bgs">
            <a href="#" data-img="landscape.jpg" class="bg active">
                <img src="${request.contextPath}/static/homepage/img/bgs/landscape.jpg" />
            </a>
            <a href="#" data-img="blueish.jpg" class="bg">
                <img src="${request.contextPath}/static/homepage/img/bgs/blueish.jpg" />
            </a>            
            <a href="#" data-img="7.jpg" class="bg">
                <img src="${request.contextPath}/static/homepage/img/bgs/7.jpg" />
            </a>
            <a href="#" data-img="8.jpg" class="bg">
                <img src="${request.contextPath}/static/homepage/img/bgs/8.jpg" />
            </a>
            <a href="#" data-img="9.jpg" class="bg">
                <img src="${request.contextPath}/static/homepage/img/bgs/9.jpg" />
            </a>
            <a href="#" data-img="10.jpg" class="bg">
                <img src="${request.contextPath}/static/homepage/img/bgs/10.jpg" />
            </a>
            <a href="#" data-img="11.jpg" class="bg">
                <img src="${request.contextPath}/static/homepage/img/bgs/11.jpg" />
            </a>
        </div>
    </div>
	<h3 class="mb10 pb10" style="height: 0px;">
		<font id="timeout" style="font-size: 0.7em; color: red; font-weight: bold; margin-left: 85%;">超时，请重新登录！</font>
    </h3>

    <div class="row-fluid login-wrapper">
        <a>
            <img class="logo" src="${request.contextPath}/static/homepage/img/logo-home.png" />
        </a>

        <div class="span4 box">
            <div class="content-wrap">
                <h6>Log in</h6>
                <input id="account-name" class="span12" maxlength="128" type="text" placeholder="请输入您的账号名" />
                <input id="account-pass" class="span12" maxlength="32" type="password" placeholder="请输入您的密码" />
                
                <input id="check-code" class="span12" maxlength="4" type="text" placeholder="请输入验证码" style="margin-top: 10px;"/>
		        <img id="check-code-image" class="span4" src="${request.contextPath}/sys/login/checkCode.uids" title="看不清，点击换一张."style="position: relative; left: 210px; bottom: 54px; height: 32px;">
                <a href="#" class="forgot" style="position: relative; bottom: 24px;"> 忘记密码?</a>
                <a id="login" class="btn-glow primary login" style="position: relative; bottom: 24px;">登 录</a>
            </div>
        </div>

    </div>
<!-- pre load bg imgs -->
<script type="text/javascript">

$(document).keyup(function(event){
	if(event.keyCode ==13){
	 	$("#login").trigger("click");
	}
});

// 全局变量
var params = {};

$(function () {
    // bg switcher
    var $btns = $(".bg-switch .bg");
    $btns.click(function (e) {
        e.preventDefault();
        $btns.removeClass("active");
        $(this).addClass("active");
        var bg = $(this).data("img");

        $("html").css("background-image", "url('${request.contextPath}/static/homepage/img/bgs/" + bg + "')");
    });
    
 	// 一开始超时提示不显示
	$('#timeout').hide();
	
	// TODO 初始化和添加验证器

});

// 点击验证码图片
$("#check-code-image").click(function() {
	// 在url里增加无用的信息，是为了更换url，从而解决缓存图片无法刷新的问题
	var imgUrl = '${request.contextPath}/sys/login/checkCode.uids?' + Math.floor(Math.random() * 100);
	$(this).attr('src', imgUrl).fadeIn();
	
	// 每次刷新验证码，都清空用户输入的验证码
	$('#check-code').val('');
});

// 点击“登录”按钮
$('#login').click(function() {
	debugger;
	$('#timeout').fadeOut();
	
	if ( buildParam() ) {
		runLogin();
	}
});


// 获取用户输入数据
function buildParam() {
	// TODO 数据校验
	if ($.trim($('#account-name').val()) == '' ) {
			layer.msg('请输入用户名！', {icon: 7,time: 1500 });
			return false;
	}
	if ( $.trim($('#account-pass').val()) == '' ) {
		layer.msg('请输入密码！', {icon: 7,time: 1500 });
		return false;
	}
	if ( $.trim($('#check-code').val()) == '' ) {
		layer.msg('请输入验证码！', {icon: 7,time: 1500 });
		return false;
	}
	params.accountName = $.trim($('#account-name').val());
	params.accountPass = $.trim($('#account-pass').val());
	params.checkCode = $.trim($('#check-code').val());
	params.loginType = "admin";
	return true;
}

// 登录
function runLogin() {
	
	var ajaxTimeout = $.ajax({
		url: '${request.contextPath}/sys/login/checkLogin.uids',
		timeout : 5000, // TODO 超时时间设置(单位毫秒)，这里可由配置信息指定
		type: 'post',
		data: params,
    	dataType: 'json',
    	beforeSend: function() {
    		loadLayer = layer.load(0, {shade: [0.5, '#fff'] });
    	},
    	success: function(data) {
    		layer.close(loadLayer);
	    	if (data.state == 1) {
	   			top.location.href='${request.contextPath}/sys/index.uids';  
	    	} else {
	    		layer.alert(data.info, {icon: 0, shade: [0.5, '#fff']});
	    		// 更新验证码
	    		$("#check-code-image").click();
	    	}
    	},
    	complete: function(XMLHttpRequest, status) {
    		// 超时(status还有success,error等值的情况)
			if (status == 'timeout'){ 
				// 取消请求
				ajaxTimeout.abort();
				// 关闭等待标识
				layer.close(loadLayer);
				// 显示超时提示
				$('#timeout').fadeIn();
			}
		}
	});
}
</script>
</body>
</html>