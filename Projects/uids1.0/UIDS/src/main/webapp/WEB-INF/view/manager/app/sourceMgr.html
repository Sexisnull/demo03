<!DOCTYPE html>
<!-- saved from url=(0062)http://118.180.24.32:8081/gsjis/manager/jisoutsideuser/list.do -->
<html style="overflow-y: hidden;">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<#include '/common.html'/>
<script type="text/javascript"
	src="${request.contextPath}/static/jquery/ui/page.js"></script>
<title>外网用户列表</title>

<script type="text/javascript">
var queryParams = {};

$(function(){
//获取表格选择行
	$('#datagrid').datagrid({    
		url:'${request.contextPath}/source/sourceList.uids',
		loadMsg: '正在加载数据，请稍后...',
		fitColumns:true,
		striped:true,
		fit:true,
		border: false,
		pagination:true,
		columns:[[
					{checkbox: true, field:'uuid'},
					{field:'name',title:'资源名称',width:20},
					{field:'code',title:'资源编码',width:10},
					{field:'url',title:'资源路径',width:20},
					{field:'app',title:'所属应用',width:20,
						 formatter: function(value,row,index){
					　　　　　　　　　if (row.app){
					                    if(row.app.name!= ''){
					                        return row.app.name;
					                    } else {
					                    	return '';
					                    }
					           }
					  }	
					},
					{field:'caozuo',title:'操作',width:15,
						formatter: function(value, row) {
							
							<@hasPerm perms="admin, app_admin">
							return '<ul><li class="operation">'
							+'<a class="hwq2button blue" onclick="grant(this)" objId="' + row.uuid + '">授权</a>'
							+'<a class="hwq2button green" onclick="edit(\''+row.uuid+'\')">编辑</a>'
							+'<a class="hwq2button gray" onclick="dele(\''+row.uuid+'\')" >删除</a>'
							+'</li></ul>';
							</@hasPerm>
							
							return '<ul><li class="operation">'
							+'<a class="hwq2button blue" onclick="grant(this)" objId="' + row.uuid + '">授权</a>'
							+'</li></ul>';
						}
					}
				]],
				toolbar:'#grid_toolbar'
	}); 
	//分页
	$('#datagrid').datagrid('getPager').pagination({
		beforePageText: '当前第',
		afterPageText: '页，共 {pages} 页',
		displayMsg: '当前显示 {from} 到 {to} ，共 {total} 条记录'
	});
})


	function toolbarAction(action) {
		switch (action) {
		case 'remove':
			var rows = $('#datagrid').datagrid('getSelections');
			
			var ids = '';
			
			for( var i = 0 ; i<rows.length; i++){
				if(i>0){
					ids +=',';
				}
				ids += rows[i].uuid;
			}
			if (ids == "") {
				alert("未选中任何记录");
				return;
			}
			dele(ids);
			break;
		case 'add':
			openDialog('${request.contextPath}/source/sourceNewOrEdit.uids', 720, 620, {
				title : '资源新增'
			});
			break;
		}
	}

	function edit(id) {
		// 检查权限
		$.ajax({
			url: '${request.contextPath}/source/checkAdminPermission.uids',
			type: 'post',
			data: {resourceIds: id},
	    	dataType: 'json',
	    	beforeSend: function() {
	    		loadLayer = layer.load(0, {shade: [0.5, '#fff'] });
	    	},
	    	success: function(data) {
	    		layer.close(loadLayer);
		    	if (data.state == 1) {
		    		openDialog('${request.contextPath}/source/sourceNewOrEdit.uids?id=' + id, 720, 600, {
		    			title : '资源编辑'
		    		});
		    	} else {
		    		layer.alert(data.info, {icon: data.state, shade: [0.5, '#fff']});
		    	}
	    	}
		});
	}

	function dele(ids) {
		confirmLayer = layer.confirm("您确定要删除这" + ids.split(",").length + "条记录吗", {
		    btn: ['确定','取消']
		},  function(r) {
			if (r) {
				// 检查权限
				$.ajax({
					url: '${request.contextPath}/source/checkAdminPermission.uids',
					type: 'post',
					data: {resourceIds: ids},
			    	dataType: 'json',
			    	beforeSend: function() {
			    		loadLayer = layer.load(0, {shade: [0.5, '#fff'] });
			    	},
			    	success: function(data) {
			    		layer.close(loadLayer);
				    	if (data.state == 1) {
				    		ajaxSubmit("${request.contextPath}/source/deleteSource.uids?ids=" + ids, {
								success : function(result) {
									layer.close(loadLayer);
						    		layer.close(confirmLayer);
									if (result.state == 1) {
										layer.msg(result.info, {icon: result.state, time: 1500, shade: [0.5, '#fff']}, function() {
						    				$('#datagrid').datagrid("reload");
							    		});
									} else {
										layer.alert(result.info);
										$("#datagrid").datagrid('reload');
									}
								}
							});
				    	} else {
				    		layer.alert(data.info, {icon: data.state, shade: [0.5, '#fff']});
				    	}
			    	}
				});
			} else {
				$("#datagrid").datagrid('reload');
			}
		});
	}
	
	function checkApp() {
		var searchName = $('#grid_simple_search').val();
			$("#datagrid").datagrid("load",{ 
				searchName:searchName
			});
	}
	
	// 授权
	function grant(obj) {
		sourceAuthorizatio($(obj).attr('objId'));
	}
	
	//资源授权
	function sourceAuthorizatio(id) {
		openDialog("${request.contextPath}/auth/sourceGrant.uids?id="+id, 800, 500, {title : '资源授权', queryParams:{id : id}});
	}
	
</script>
</head>
<body class="easyui-layout">
    <div data-options="region:'north'">
		<div id="page-title">
			<span class="switchmenu"><i class="icon-user"></i> 资源管理 - <span
				id="page-title-text">全部资源</span> <i class="icon-caret-down"></i></span>
		</div>
	</div>
	<div data-options="region:'center',fit:false">
		<div id="grid_toolbar">
		<@hasPerm perms="admin, app_admin">
			<div class="datagrid-toolbar-btn-wrap">
				<a class="datagrid-toolbar-btn" onclick="toolbarAction('add')"><i class="icon-plus-sign"></i>新增</a> 
				<a class="datagrid-toolbar-btn" onclick="toolbarAction('remove')"><i class="icon-minus-sign"></i>删除</a>
			</div>
		</@hasPerm>
			<div class="datagrid-toolbar-search-wrap">
				<div class="datagrid-toolbar-simple-search">
					<form>
						<input type="text" id="grid_simple_search" class="input-text"
							style="width: 150px;" name="searchText" value=""
							placeholder="请输入资源名称" />
					</form>
					<input type="button" class="btn btn-small btn-primary"
						style="margin-left: 5px;" onclick="checkApp()" value="检索" />
				</div>
			</div>
		</div>
		<table id="datagrid"></table>
	</div>
	<div style="display: none">
		<input type="text" id="orgCode" value="111" />
	</div>
</body>
</html>