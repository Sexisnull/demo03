<!DOCTYPE html>
<html style="overflow-y:hidden;">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>统一身份认证</title>
<#include '/common.html'/>
<script type="text/javascript" src="${request.contextPath}/static/jquery/ui/page.js"></script>
</head>
<body class="easyui-layout" data-options="fit:false">  
	<div data-options="region:'north'">
		<div id="page-title">
			区域列表
		</div>
	</div>  
	<div data-options="region:'center',fit:false">
		<div id="grid_toolbar">
		<@hasPerm perms="admin">
			<div class="datagrid-toolbar-btn-wrap">
				<a class="datagrid-toolbar-btn" onclick="toolbarAction('add')"><i class="icon-plus-sign"></i>新增</a>
				<a class="datagrid-toolbar-btn" onclick="toolbarAction('remove')"><i class="icon-minus-sign"></i>删除</a>
				<a class="datagrid-toolbar-btn" onclick="toolbarAction('open')"><i></i>启用</a>
				<a class="datagrid-toolbar-btn" onclick="toolbarAction('close')"><i></i>禁用</a>
			</div>
		</@hasPerm>
			<div class="datagrid-toolbar-search-wrap">
				<div class="datagrid-toolbar-simple-search">
					<input type="text" id="grid_simple_search" class="input-text" style="width:150px;" name="searchText" value="" placeholder="请输入区域名称"/>
					<input id="search" type="submit" class="btn btn-small btn-primary" style="margin-left:5px;" value="检索" onclick="advancesearchCheck()"/>
				</div>
			</div>
	   </div>
	   <table id="datagrid"></table>
	</div>
<script type="text/javascript">
var queryParams = {rootId: '${rootId}'};
$(function() {
	//获取list数据
	$('#datagrid').datagrid({
		url:'${request.contextPath}/sysArea/list.uids',
		queryParams: queryParams,
		loadMsg: '正在加载数据，请稍后...',
		fitColumns:true,
		striped:true,
		fit:true,
		border: false,
		pagination: true,
		columns:[[
			{checkbox: true, field:'uuid'},
			{field:'name',title:'区域名称',width:100},
			{field:'code',title:'区域编码',width:100},
			{field:'createTime',title:'创建时间',width:200},
			{field:'parent.uuid',title:'上级区域',width:200,
				formatter: function(value, rows, index){
					if(rows.parentUuid == 0){
						return '无';
					}else{
						return rows.parentName;
					}
				}
			},
			{field:'validStatus',title:'状态',width:50,
				formatter: function(value, row, index) {
					if(row.validStatus == 0){
						return '启用';
					}else{
						return '禁用';
					}
				}
			},
			<@hasPerm perms="admin">
			{field:' ',title:'操作',width:150,
				formatter: function(value, rows, index) {
					
					var openOrClose = "";
					if(rows.validStatus == 0){
						openOrClose = '<a class="hwq2button gray" onclick="openOrClose(\'close\',\''+rows.uuid+'\')">禁用</a>';
					} else {
						openOrClose = '<a class="hwq2button blue" onclick="openOrClose(\'open\',\''+rows.uuid+'\')">启用</a>';
					}
					
					return '<ul><li class="operation">'
					+'<a class="hwq2button green" onclick="edit(\''+rows.uuid+'\')" >编辑</a>'
					+ openOrClose +'</li></ul>';
					
				}
			}
			</@hasPerm>
		]],
		toolbar:'#grid_toolbar'
	});
	//分页
	$('#datagrid').datagrid('getPager').pagination({
		beforePageText: '当前第',
		afterPageText: '页，共 {pages} 页',
		displayMsg: '当前显示 {from} 到 {to} ，共 {total} 条记录'
	});
})
//普通检索-检索button
function advancesearchCheck(){
	queryParams.searchText = $.trim($('#grid_simple_search').val());
	$('#datagrid').datagrid('load', queryParams);
}

function toolbarAction(action) {
		//获取选中行
		var rows = $('#datagrid').datagrid('getSelections');
		var ids = '';
		for( var i = 0 ; i<rows.length; i++){
			if(i>0){
				ids +=',';
			}
			ids += rows[i].uuid;
		}
	
		switch (action) {
		case 'remove':
			if (ids == "") {
				alert("未选中任何记录");
				return;
			}
			dele(ids);
			break;
		case 'add':
			openDialog('${request.contextPath}/sysArea/newOrEdit.uids?&rootId=${rootId}', 550, 420, {
				title : '区域新增'
			});
			break;
		case 'open':
			if (ids == "") {
				alert("未选中任何记录");
				return;
			}
			confirmLayer = layer.confirm("您确定要启用这" + ids.split(",").length + "条记录吗", {
			    btn: ['确定','取消']
			}, function() {
				ajaxSubmit("${request.contextPath}/sysArea/openOrClose.uids?ids=" + ids+"&status="+action,{
					success:function(result){
						if(result.state == 1){
							layer.close(confirmLayer);
							layer.msg(result.info, {icon: result.state, time: 1500, shade: [0.5, '#fff']}, function() {
								refreshTree();
				    		});
						}else{
							layer.alert(result.info);
						}
					}
				});
			});
			break;
		case 'close':
			if (ids == "") {
				alert("未选中任何记录");
				return;
			}
			confirmLayer = layer.confirm("您确定要禁用这" + ids.split(",").length + "条记录吗", {
			    btn: ['确定','取消']
			}, function() {
				ajaxSubmit("${request.contextPath}/sysArea/openOrClose.uids?ids=" + ids+"&status="+action,{
					success:function(result){
						if(result.state == 1){
							layer.close(confirmLayer);
							layer.msg(result.info, {icon: result.state, time: 1500, shade: [0.5, '#fff']}, function() {
								refresh();
				    		});
						}else{
							layer.alert(result.info);
						}
					}
				});
			});
			break;
		}
}

function edit(id) {
	openDialog('${request.contextPath}/sysArea/newOrEdit.uids?iid=' + id+'&rootId=${rootId}', 550, 420, {
		title : '区域编辑'
	});
}

function dele(ids) {
	confirmLayer = layer.confirm("您确定要删除这" + ids.split(",").length + "条记录吗", {
	    btn: ['确定','取消']
	}, function() {
		ajaxSubmit("${request.contextPath}/sysArea/dele.uids?ids=" + ids+'&rootId=${rootId}',{
			success:function(result){
				if(result.state == 1){
					//删除成功后，先刷新树，后刷新列表
					layer.close(confirmLayer);
					layer.msg(result.info, {icon: result.state, time: 1500, shade: [0.5, '#fff']}, function() {
						refreshTree();
		    		});
				}else{
					layer.alert(result.info);
				}
			}
		});
	});
}
//单个打开或关闭
function openOrClose(status,id){
	var showStr = (status == "open")?"启用":"禁用";
	confirmLayer = layer.confirm('确定'+showStr+'所选数据？', {
	    btn: ['确定','取消']
	}, function() {
		ajaxSubmit('${request.contextPath}/sysArea/openOrClose.uids?ids=' + id+'&status='+status,{
			success:function(result){
				if(result.state == 1){
					layer.close(confirmLayer);
					layer.msg(result.info, {icon: result.state, time: 1500, shade: [0.5, '#fff']}, function() {
						refresh();
		    		});
				}else{
					layer.alert(result.info);
				}
			}
		});
	});
}

function refresh(){
	$('#datagrid').datagrid("reload");
}
</script>
</body>
</html>