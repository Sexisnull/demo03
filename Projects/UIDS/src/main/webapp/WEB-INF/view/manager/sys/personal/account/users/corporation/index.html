<!DOCTYPE html>
<html>
<head>
<title>用户资料</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

<!-- global styles -->
<link rel="stylesheet" type="text/css" href="${request.contextPath}/static/homepage/css/layout.css" />
<link rel="stylesheet" type="text/css" href="${request.contextPath}/static/homepage/css/elements.css" />
<link rel="stylesheet" type="text/css" href="${request.contextPath}/static/homepage/css/icons.css" />

<!-- easyui -->
<link rel="stylesheet" type="text/css" href="${request.contextPath}/static/jquery/easyui/themes/default/easyui.css">
<link rel="stylesheet" type="text/css" href="${request.contextPath}/static/jquery/easyui/themes/icon.css">
<script type="text/javascript" src="${request.contextPath}/static/jquery/jquery-1.8.0.min.js"></script>
<script type="text/javascript" src="${request.contextPath}/static/jquery/easyui/jquery.min.js"></script>
<script type="text/javascript" src="${request.contextPath}/static/jquery/easyui/jquery.easyui.min.js"></script>

<!-- layui -->
<script type="text/javascript" src="${request.contextPath}/static/layer/layer.js"></script>
<link rel="stylesheet" type="text/css" href="${request.contextPath}/static/layer/skin/default/layer.css">
<link rel="stylesheet" type="text/css" href="${request.contextPath}/static/layui/css/layui.css">
<script type="text/javascript" src="${request.contextPath}/static/layui/layui.js"></script>
<#include '/validate.html'/>
<style type="text/css">
.layui-form-label em{
    color: red;
    position: relative;
    top: 3px;
    font-weight: 600;
    float:right;
}
</style>
<script type="text/javascript">
layui.use('element', function(){
  	var $ = layui.jquery,element = layui.element(); //Tab的切换功能，切换事件监听等，需要依赖element模块
});

layui.use( [ 'form', 'layedit', 'laydate' ],
function() {
	var form = layui.form(), layer = layui.layer, layedit = layui.layedit, laydate = layui.laydate;
	debugger;
	//创建一个编辑器
	var editIndex = layedit.build('LAY_demo_editor');
});

// 保存的参数
var params = {accountId: '${accountId}', createTime: '${info.createTime!''}', status: '${info.status!''}', type: '2'};
var updateParams = {userId: '${info.uuid!''}', detailId: '${detail.uuid!''}', createTime: '${info.createTime!''}', status: '${info.status!''}', type: '2'};
//发送方的标识符：SmsRecord记录的uuid
var add_mark = null;

var corporateType ='${info.corporateType!''}';
	
$(function() {
	// 设置实名认证状态
	setAuthStatus($('#real-name-auth').attr('userStatus'));
	
	var user = '${info.uuid!''}';
	if(user == ''){
		//选择法人类型
	  	selectCorporateType();
	}else{
		//设置为法人字段或非法人字段
		setFieldEchoInfo(corporateType);
		//设置禁止修改字段
		setProhibitedModify();
	}
	
	//验证
	$.validator.setDefaults({  
        submitHandler: function() {
        	if(user != ''){
        		updateInfo();
        	}else{
            	saveInfo();
        	}
        }
    });  
	$().ready(function() {
		$('#saveBtn').click(function(){
			debugger;
			var len = $('input[placeholder=请选择]').length;
			for(var i=0;i < len;i++){
				debugger;
				$('input[placeholder=请选择]:eq('+i+')').attr('name',i);
			}
			gswwValidate($("#oprform"));
		});
	});
	
	// 设置初值
	initSelect($("#nationality"), $("#nationality").attr('data-value'));
	
	// 如果已经实名认证了，则相关字段不允许编辑
	if ( params.status == 3 ) {
		$('#identity').attr("disabled", true);
	}
	
	// 如果是用户登录后修改自己的资料，则姓名、身份证号是不允许修改的
	var isEditSelf = "${isEditSelf!'1'}";
	if ( isEditSelf != '0' ) {
		$('#tr-name').hide();
		$('#tr-identity').hide();
	}

	// 短信验证码按钮的倒计时设置
	var valid_time = 60;
	var util = {
		wait : valid_time,
		hsTime : function(obj) {
			var _this = this;
			if (_this.wait <= 0) {
				$(obj).removeAttr("disabled").val('重发短信验证码');
				_this.wait = valid_time;
			} else {
				$(obj).attr("disabled", true).val(
						'在' + _this.wait + '秒后点此重发');
				_this.wait--;
				setTimeout(function() {
					_this.hsTime(obj);
				}, 1000)
			}
		}
	};

	// 绑定新建用户：发送短信验证码
	$('#add-btn-send-code').click(function() {
		// TODO 字段校验

		var mobile = $.trim($('#mobile').val());
		
		if(!checkMobile(mobile)){
			layer.msg('请输入正确的手机号码！', {icon: 7,time: 1500 });
			return;
		}
		// 设置按钮
		util.hsTime('#add-btn-send-code');

		// 提交给后台处理：后台去发送手机验证码
		$.ajax({
			url : '${request.contextPath}/sys/sendCode.uids',
			type : 'post',
			data : {
				mobile : mobile, type: 3
			},
			dataType : 'json',
			beforeSend : function() {
				loadLayer = layer.load(0, {
					shade : [ 0.5, '#fff' ]
				});
			},
			success : function(data) {
				layer.close(loadLayer);
				layer.alert(data.info, {
					icon : data.state,
					time : 1500,
					shade : [ 0.5, '#fff' ]
				});
				if (data.state == 1) {
					// SmsRecord记录的uuid
					add_mark = data.data;
				}
			}
		});
	});

	$("#Non-essential").hide();
	// TODO 添加参数校验	
});
	
// 设置实名认证状态
function setAuthStatus(status) {
	
	$('#real-name-auth').attr('userStatus', status);
	
	switch(status) {
	case '3' : 
		$('#real-name-auth').text('已实名');
		$('#real-name-auth').attr('class', 'layui-btn layui-btn-primary layui-btn-radius');
		$('#real-name-auth').attr('disabled', 'true');
		break;
	default:
		$('#real-name-auth').text('立即实名认证');
	}
}	

// 点击实名认证按钮
function realNameAuth(obj) {
	debugger;
	$.ajax({
		url: '${request.contextPath}/sys/realNamelAuth.uids',
		data: {userId: $(obj).attr('userId')},
		type: 'post',
    	dataType: 'json',
    	beforeSend: function() {
    		loadLayer = layer.load(0, {shade: [0.6, '#fff'] });
    	},
    	success: function(data) {
    		layer.close(loadLayer);
    		
    		layer.alert(data.info, {icon: data.state, time: 1500, shade: [0.5, '#fff']});
    		
    		// 设置认证状态
    		if ( data.state == 1 ) {
    			setAuthStatus(data.data + '');
    		}	    		
    	}
	});
}
	
// 设置字段的显示信息
function setFieldEchoInfo(type) {
	
	if ( type == 'corporate' ) {
		$('.cop').show();
		$('.nocop').hide();
	} else{
		$('.cop').hide();
		$('.nocop').show();
	}
}
	
//清空某个select列表
function clearSelect(obj) {
	$(obj).empty();
	$(obj).append('<option value="">请选择</option>');
}

// 构建参数
function buildParams() {
	
	// TODO 参数校验
	//基本信息
	if ( corporateType == 'corporate' ) {
		params.corporateName = $.trim($('#corporate-name').val());
		params.name = $.trim($('#person-name').val());
	}else{
		params.corporateName = $.trim($('#corporateName').val());
		params.name = $.trim($('#personName').val());
	}
	params.nationality = $.trim($('#nationality').val());
	params.identity = $.trim($('#identity').val());
	params.mobile = $.trim($('#mobile').val());
	params.email = $.trim($('#email').val());
	params.creditCode = $.trim($('#credit-code').val());
	params.orgCode = $.trim($('#org-code').val());	
	params.companyTel = $.trim($('#work-phone').val());
	params.businessScope = $.trim($('#business-scope').val());
	params.corporateType = corporateType;
	
	params.mark = add_mark;
	params.code = $.trim($('#add-code').val());
	
	//日志相关参数
 	if( params.userId == '' ){
 		params.operate = 'insert';
 	}else{
 		params.operate = 'update';
 	}
}
	
function buildUpdateParams() {
	
	// TODO 参数校验
	//基本信息
	if ( corporateType == 'corporate' ) {
		updateParams.corporateName = $.trim($('#corporate-name').val());
		updateParams.name = $.trim($('#person-name').val());
	}else{
		updateParams.corporateName = $.trim($('#corporateName').val());
		updateParams.name = $.trim($('#personName').val());
	}
	updateParams.nationality = $.trim($('#nationality').val());
	updateParams.identity = $.trim($('#identity').val());
	updateParams.mobile = $.trim($('#mobile').val());
	updateParams.email = $.trim($('#email').val());
	updateParams.creditCode = $.trim($('#credit-code').val());
	updateParams.orgCode = $.trim($('#org-code').val());	
	updateParams.companyTel = $.trim($('#work-phone').val());
	updateParams.businessScope = $.trim($('#business-scope').val());
	updateParams.corporateType = corporateType;
	
	updateParams.mark = add_mark;
	updateParams.code = $.trim($('#add-code').val());
	
	//日志相关参数
 	if( updateParams.userId == '' ){
 		updateParams.operate = 'insert';
 	}else{
 		updateParams.operate = 'update';
 	}
}
		
//保存信息
function saveInfo() {
	buildParams();
	$.ajax({
		url: '${request.contextPath}/account/runBindNewUser.uids',
		type: 'post',
		data: params,
    	dataType: 'json',
    	beforeSend: function() {
    		loadLayer = layer.load(0, {shade: [0.5, '#fff'] });
    	},
    	success: function(data) {
    		layer.close(loadLayer);
	    	if (data.state == 1) {
	    		layer.msg(data.info, {icon: data.state, time: 500, shade: [0.5, '#fff']}, function() {
	    			window.location.reload(); 
	    		});
	    	} else {
	    		layer.alert(data.info, {icon: 0, shade: [0.5, '#fff']});
	    	}
    	}
	});
}
	
	//更新信息
function updateInfo() {
	buildUpdateParams();
	$.ajax({
		url: '${request.contextPath}/account/updateUser.uids',
		type: 'post',
		data: updateParams,
    	dataType: 'json',
    	beforeSend: function() {
    		loadLayer = layer.load(0, {shade: [0.5, '#fff'] });
    	},
    	success: function(data) {
    		layer.close(loadLayer);
	    	if (data.state == 1) {
	    		layer.msg(data.info, {icon: data.state, time: 500, shade: [0.5, '#fff']}, function() {
	    			window.location.reload(); 
	    		});
	    	} else {
	    		layer.alert(data.info, {icon: 0, shade: [0.5, '#fff']});
	    	}
    	}
	});
}
	
// 设置某个select标签初值
function initSelect(obj, value) {
	$(obj).val(value);
}
//选择法人类型
function selectCorporateType(){
	layer.msg('请选择要绑定的用户类型', {
		  offset: '100px',
		  time: 0 //不自动关闭
		  ,shade: [0.6, '#F9F9F9']
		  ,btn: ['企业法人', '非企业法人']
		  ,yes: function(index){
		    layer.close(index);
		 	//设置企业法人或非企业法人字段
			setFieldEchoInfo('corporate');
			corporateType = 'corporate';
		  },btn2: function(index){
			layer.close(index);
			setFieldEchoInfo('organization');
			corporateType = 'organization';
		  }
		});
}

//设置禁止修改字段
function setProhibitedModify(){
	$('#corporate-name').attr('disabled','true');
	$('#corporateName').attr('disabled','true');
	$('#person-name').attr('disabled','true');
	$('#personName').attr('disabled','true');
	$('#identity').attr('disabled','true');
	$('#mobile').attr('disabled','true');
	$('#credit-code').attr('disabled','true');
	$('#org-code').attr('disabled','true');
}

</script>
</head>
<body style="overflow: hidden;">
	<!-- main container -->
	<div class="content">
		<div class="container-fluid">
			<div id="pad-wrapper" style="margin-top: 30px;">
				<fieldset class="layui-elem-field layui-field-title"
					style="margin-top: 20px;">
					<legend>完善用户信息</legend>
				</fieldset>
				<form action="" class="layui-form" method="post" id="oprform" name="oprform">
				<div class="layui-tab layui-tab-brief" lay-filter="docDemoTabBrief">
					  <ul class="layui-tab-title">
					    <li class="layui-this">基本信息</li>
					    <li>详细信息</li>
					  </ul>
					  <div class="layui-tab-content" method="post" style="height: 100px;">
					    <div class="layui-tab-item layui-show">
							<div id="company_name" class="layui-form-item cop">
							    <label class="layui-form-label">企业名称<em>*</em></label>
							    <div class="layui-input-block">
							      <input type="text" id="corporate-name" name="corporate-name" required maxlength="128" value="${info.corporateName!''}"  placeholder="请输入企业名称" class="layui-input">
							    </div>
							  </div>
							   <div id="org_name" class="layui-form-item nocop">
							    <label class="layui-form-label">机构名称<em>*</em></label>
							    <div class="layui-input-block">
							      <input type="text" id="corporateName" name="corporateName" required value="${info.corporateName!''}" maxlength="128" placeholder="请输入机构名称" class="layui-input">
							    </div>
							  </div>
							  <div id="credit_code" class="layui-form-item cop">
							    <label class="layui-form-label" style="padding: 9px 12px; width: 81px;">注册号/代码<em>*</em></label>
							    <div class="layui-input-block">
							      <input type="text" id="credit-code" name="credit-code" required  value="${info.creditCode!''}" maxlength="18" minlength="15"  placeholder="请输入企业工商注册号／统一社会信用代码" class="layui-input">
							    </div>
							  </div>
							  <div class="layui-form-item">
							    <label class="layui-form-label">机构代码<em>*</em></label>
							    <div class="layui-input-block">
							      <input type="text" id="org-code" name="org-code" required value="${info.orgCode!''}" maxlength="10" minlength="10" placeholder="请输入组织机构代码" class="layui-input">
							    </div>
							  </div>
							  <#if info.uuid??>
								<div class="layui-inline">
									<div>
										<button id="real-name-auth" type="button" onclick="realNameAuth(this)" userId="${info.uuid}" userStatus="${info.status}" class="layui-btn layui-btn-danger"></button>
									</div>
								</div>
							  </#if>
							  <div class="layui-form-item">
							    <div id="legal_person" class="layui-inline cop">
							      <label class="layui-form-label">法人姓名<em>*</em></label>
							      <div class="layui-input-inline">
							        <input type="text" id="person-name" name="person-name" required value="${info.name!''}" maxlength="64" placeholder="请输入法人姓名" class="layui-input">
							      </div>
							    </div>
							    <div id="no_Legal_person" class="layui-inline nocop">
							      <label class="layui-form-label">负责人姓名<em>*</em></label>
							      <div class="layui-input-inline">
							        <input type="text" id="personName" name="person-name" required value="${info.name!''}" maxlength="64" placeholder="请输入负责人姓名" class="layui-input">
							      </div>
							  	</div>
							    <div class="layui-inline">
							      <label class="layui-form-label">名族</label>
							      <div class="layui-input-block">
							      <#assign text>
										${nationalities}
									</#assign>
									<#assign jsonarray = text?eval />
							      <select id="nationality" name="nationality" required data-value="${info.nationality!''}">
							        <option value="">请选择</option>
						        		<#list jsonarray as item>
						        			<option value="${item.number}">${item.value!''}</option>
						        		</#list>
							      </select>
							    </div>
							    </div>
							  </div>
							    <div class="layui-form-item">
							      <label class="layui-form-label">身份证号<em>*</em></label>
							      <div class="layui-input-block">
							        <input type="tel" id="identity" name="identity" required value="${info.identity!''}" placeholder="请输入身份证号" minlength="15" maxlength="18" rang class="layui-input">
							      </div>
							    </div>
							    <div class="layui-form-item">
									<label class="layui-form-label">手机号码<em>*</em></label>
									<div class="layui-input-block">
										<input type="text" name="mobile" id="mobile" required maxlength="11" lay-verify="required" placeholder="请输入手机号码" autocomplete="off" class="layui-input" value="${info.mobile!''}">
									</div>
								</div>
								<div class="layui-form-item">
									<label class="layui-form-label">短信验证码</label>
									<div class="layui-input-inline">
										<input type="text" name="password" required id="add-code" required lay-verify="pass" placeholder="请输入短信验证码" autocomplete="off" class="layui-input" maxlength="6">
									</div>
									<input type="button" id="add-btn-send-code" name="add-btn-send-code" class="layui-btn layui-btn-warm" value="发送短信验证码" style="margin-bottom: 10px;">
								</div>
							</div>
							<div class="layui-tab-item">
							   <div class="layui-form-item">
							      <label class="layui-form-label">邮箱<em>*</em></label>
							      <div class="layui-input-block">
							        <input type="text" id="email" name="email" required maxlength="128" value="${info.email!''}" placeholder="请输入邮箱账号" class="layui-input">
							      </div>
							    </div>
							    <div class="layui-form-item">
							      <label class="layui-form-label">办公电话</label>
							      <div class="layui-input-block">
							        <input type="tel" id="work-phone" name="work-phone" maxlength="11" minlength="11" value="${detail.companyTel!''}" placeholder="请输入办公电话" class="layui-input">
							      </div>
							    </div>
								  <div class="layui-form-item">
								    <label class="layui-form-label">经营范围</label>
								    <div class="layui-input-block">
								      <input type="text" id="business-scope" name="business-scope" placeholder="请输入经营范围" maxlength="128" value="${detail.businessScope!''}" class="layui-input">
								    </div>
								  </div>
							  </div>
					    <div class="layui-form-item">
							<div class="layui-input-block">
								<input type="submit"  name="submit" class="layui-btn" value="立即提交" id="saveBtn">
							</div>
						</div>
					  </div>
					</div>
					</form>
			</div>
		</div>
	</div>
</body>
</html>