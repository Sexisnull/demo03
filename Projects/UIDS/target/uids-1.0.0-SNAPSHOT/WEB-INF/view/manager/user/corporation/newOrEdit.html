<!DOCTYPE html>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>法人新增或编辑</title>
<#include '/common.html'/>
<#include '/validate.html'/>
</head>
<body class="easyui-layout">
	<form action="" method="post" id="oprform" name="oprform">
	<div region="center" style="overflow-y: auto;">
		<div class="easyui-tabs" data-options="border:false, fit:true, plain:true">		
			<div title="基本信息" style="padding: 10px; overflow-y: auto;">			
				<table border="0" align="center" cellpadding="10" cellspacing="0" class="table">
					<tbody>
						<tr id="tr-corporate-type">
							<td align="right" class="label"></td>
							<td></td>
							<td>
								<input type="radio" id="corporate-radio" name="corporate-type" value="corporate"/>企业法人
								<input type="radio" id="noncorporate-radio" name="corporate-type" value="organization"/>非企业法人
							</td>
						</tr>
						<tr id="tr-corporate-name">
							<td id="td-corporate-name" align="right" class="label" style="padding:10px"></td>
							<td class="required" style="padding:5px">*</td>
							<td>
								<input type="text" id="corporate-name" name="corporate-name" required maxlength="128" value="${info.corporateName!''}" class="input-text">
							</td>
						</tr>
						<tr id="tr-credit-code">
							<td align="right" class="label" style="padding:10px">企业工商注册号/统一社会信用代码</td>
							<td class="required" style="padding:5px">*</td>
							<td>
								<input type="text" id="credit-code" name="credit-code" required  rangelength="[15,18]"  maxlength="18" minlength="15" value="${info.creditCode!''}" class="input-text">
							</td>
						</tr>
						<tr id="tr-org-code">
							<td align="right" class="label" style="padding:10px">组织机构代码</td>
							<td class="required" style="padding:5px">*</td>
							<td>
								<input type="text" id="org-code" name="org-code" required  maxlength="10" minlength="10" value="${info.orgCode!''}" class="input-text">
							</td>
						</tr>
						<tr id="tr-person-name">
							<td id="td-person-name" align="right" class="label" style="padding:10px"></td>
							<td class="required" style="padding:5px">*</td>
							<td>
								<input type="text" id="person-name" name="person-name" required maxlength="128"  value="${info.name!''}" class="input-text">
							</td>
						</tr>
						<tr>
							<td id="td-person-nationality" align="right" class="label" style="padding:10px"></td>
							<td class="required" style="padding:5px">*</td>
							<td>
								<#assign text>
									${nationalities}
								</#assign>
								<#assign jsonarray = text?eval />					
								<select id="nationality" name="nationality" required data-value="${info.nationality!''}" class="input-text">		        		
					        		<option value="">---请选择---</option>
					        		<#list jsonarray as item>
					        			<option value="${item.number}">${item.value!''}</option>
					        		</#list>
					        	</select>
							</td>
						</tr>
						<tr id="tr-identity">
							<td id="td-identity" align="right" class="label" style="padding:10px"></td>
							<td class="required" style="padding:5px">*</td>
							<td>
								<input type="text" id="identity" name="identity" required value="${info.identity!''}" class="input-text">
							</td>
						</tr>
					</tbody>
				</table>
			</div>
			
			<div title="详细信息" style="padding: 10px; overflow-y: auto;">
				<table border="0" align="center" cellpadding="10" cellspacing="0" class="table">
					<tbody>						
						<tr>
							<td align="right" class="label" style="padding:10px">手机号</td>
							<td class="required" style="padding:5px">*</td>
							<td>
								<input type="text" id="mobile" name="mobile" required  digits="true" maxlength="11" minlength="11" value="${info.mobile!''}" class="input-text">
							</td>
						</tr>
						<tr>
							<td align="right" class="label" style="padding:10px">邮箱</td>
							<td class="required" style="padding:5px">*</td>
							<td>
								<input type="text" id="email" name="email" required  maxlength="128" value="${info.email!''}" class="input-text">
							</td>
						</tr>
						<tr>
							<td align="right" class="label" style="padding:10px">办公电话</td>
							<td style="padding:5px"></td>
							<td>
								<input type="text" id="work-phone" name="work-phone"  maxlength="14" minlength="14" value="${detail.companyTel!''}" class="input-text">
							</td>
						</tr>
						<tr>
							<td align="right" class="label" style="padding:10px">经营范围</td>
							<td style="padding:5px"></td>
							<td>
								<input type="text" id="business-scope" name="business-scope" maxlength="128"  value="${detail.businessScope!''}" class="input-text">
							</td>
						</tr>
					</tbody>
				</table>	
			</div>
		</div>
	</div>
	
	<div region="south" id="dialog-toolbar">
		<div id="dialog-toolbar-panel">
			<input type="submit" name="save" class="btn btn-primary" value="保  存" id="saveBtn"> 
			<input type="button" name="cancel" class="btn btn-cancel" value="取消" onclick="closeDialog();">
		</div>
	</div>
	</form>
</body>

<script type="text/javascript">

// 保存的参数
var params = {type: '${info.type}', userId: '${info.uuid!''}', detailId: '${detail.uuid!''}', createTime: '${info.createTime!''}', 
		status: '${info.status!''}'};

$(function() {

	//验证
	$.validator.setDefaults({  
        submitHandler: function() {
            saveInfo();
        }  
    });  
	$().ready(function() {
		$('#saveBtn').click(function(){
			debugger;
			gswwValidate($("#oprform"));
		});
	});
	
	// 设置初值
	initSelect($("#nationality"), $("#nationality").attr('data-value'));
	initRadio('corporate-type', "${info.corporateType!'corporate'}");
	setFieldEchoInfo("${info.corporateType!'corporate'}");
	
	// 更改法人类型的触发事件
	$('input:radio[name="corporate-type"]').change(function() {
		setFieldEchoInfo($(this).val());
	});
	
	// 如果是编辑法人，则不显示法人类型
	if ( params.userId != '' ) {		
		$('#tr-corporate-type').hide();
	}
	
	// 如果已经实名认证了，则相关字段不允许编辑
	if ( params.status == 3 ) {
		$('#corporate-name').attr("disabled", true);
		$('#credit-code').attr("disabled", true);
		$('#org-code').attr("disabled", true);
		$('#person-name').attr("disabled", true);
		$('#identity').attr("disabled", true);
	}
	
	// 如果是用户登录后修改自己的资料，则姓名、身份证号是不允许修改的
	var isEditSelf = "${isEditSelf!'1'}";
	if ( isEditSelf != '0' ) {
		$('#corporate-name').hide();
		$('#credit-code').hide();
		$('#org-code').hide();
		$('#person-name').hide();
		$('#identity').hide();
	}
});

// 设置某个select标签初值
function initSelect(obj, value) {
	$(obj).val(value);
}

// 初始化radio标签
function initRadio(radioName, radioValue) {
	$(":radio[name=" + radioName + "][value=" + radioValue + "]").prop("checked", "checked");
}

//设置字段的显示信息
function setFieldEchoInfo(corporateType) {
	if ( corporateType == 'corporate' ) {
		$('#td-corporate-name').text('企业名称');
		$('#tr-credit-code').show();
		$('#td-person-name').text('法人姓名');
		$('#td-person-nationality').text('法人名族');
		$('#td-identity').text('法人身份证号');
	} else if ( corporateType == 'organization' ) {
		$('#td-corporate-name').text('机构名称');
		$('#tr-credit-code').hide();
		$('#td-person-name').text('负责人姓名');
		$('#td-person-nationality').text('负责人名族');
		$('#td-identity').text('负责人身份证号');
	}
}

// 构建参数
function buildParams() {
	debugger;
	// TODO 参数校验
	params.corporateType = $.trim($('input[name="corporate-type"]:checked').val());
	params.corporateName = $.trim($("#corporate-name").val());
	params.creditCode = $.trim($("#credit-code").val());
	params.orgCode = $.trim($("#org-code").val());
	params.name = $.trim($("#person-name").val());
	params.nationality = parseInt($.trim($("#nationality").val()));
	params.identity = $.trim($("#identity").val());
	params.mobile = $.trim($("#mobile").val());
	params.email = $.trim($("#email").val());
	
	params.companyTel = $.trim($("#work-phone").val());
	params.businessScope = $.trim($("#business-scope").val());
	if (params.mobile == '') {
		layer.msg('请输入手机号！', {icon: 7,time: 1500 });
		return false;
	} else if ( !checkMobile(params.mobile)) {
		layer.msg('请输入正确的手机号！', {icon: 7,time: 1500 });
		return false;
	}
	if (params.email == '') {
		layer.msg('请输入邮箱！', {icon: 7,time: 1500 });
		return false;
	} else if ( !checkEmail(params.email)) {
		layer.msg('请输入正确的邮箱！', {icon: 7,time: 1500 });
		return false;
	}
	//日志相关参数
 	if( params.userId == '' ){
 		params.operate = 'insert';
 	} else {
 		params.operate = 'update';
 	}
	return true;
}
	
//保存信息
function saveInfo() {
	if(!buildParams()){
		return;
	}
	$.ajax({
		url: '${request.contextPath}/user/saveOrUpdate.uids',
		type: 'post',
		data: params,
    	dataType: 'json',
    	beforeSend: function() {
    		loadLayer = layer.load(0, {shade: [0.5, '#fff'] });
    	},
    	success: function(data) {
    		layer.close(loadLayer);
	    	if (data.state == 1) {
    			closeDialog(true);
	    	} else {
	    		layer.alert(data.info, {icon: 0, shade: [0.5, '#fff']});
	    	}
    	}
	});
}

</script>
</html>